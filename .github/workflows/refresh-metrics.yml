name: Refresh metrics weekly

on:
  schedule:
    - cron: "0 3 * * 1"   # Mondays 03:00 UTC
  workflow_dispatch:

jobs:
  refresh:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout project
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          # Needed for the notebook + upload
          pip install papermill ipykernel huggingface_hub matplotlib

      - name: Show repo files (debug)
        run: |
          ls -la
          echo "-----"
          if [ -f AB_Test.ipynb ]; then echo "Found AB_Test.ipynb"; else echo "MISSING AB_Test.ipynb" && exit 1; fi

      - name: Run notebook with Papermill (regenerates metrics.json)
        run: |
          python - << 'PY'
          import papermill as pm
          pm.execute_notebook(
              'AB_Test.ipynb',
              'AB_Test_Output.ipynb'
          )
          print("✅ Notebook executed")
          PY

      - name: Verify metrics.json exists (debug)
        run: |
          if [ -f metrics.json ]; then
            echo "✅ metrics.json present:"
            cat metrics.json
          else
            echo "❌ metrics.json not found after notebook run"
            exit 1
          fi

      - name: Fail clearly if HF_TOKEN not set
        run: |
          if [ -z "${{ secrets.HF_TOKEN }}" ]; then
            echo "❌ GitHub secret HF_TOKEN is missing."
            exit 1
          fi

      - name: Publish metrics.json to Hugging Face Space
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          python - << 'PY'
          import os
          from huggingface_hub import HfApi

          token = os.environ.get("HF_TOKEN")
          if not token:
              raise SystemExit("HF_TOKEN env var missing")

          api = HfApi()
          api.upload_file(
              path_or_fileobj="metrics.json",
              path_in_repo="metrics.json",
              repo_id="darshitkumar/ab-metrics",   # <— your Space
              repo_type="space",
              token=token
          )
          print("✅ Uploaded metrics.json to Space")
          PY
