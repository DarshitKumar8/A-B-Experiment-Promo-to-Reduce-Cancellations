name: Refresh metrics weekly

on:
  schedule:
    - cron: "0 3 * * 1"   # Every Monday 03:00 UTC
  workflow_dispatch:       # Allow manual run

jobs:
  refresh:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout project
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install papermill huggingface_hub

      - name: Run notebook with Papermill (regenerates metrics.json)
        run: |
          python - << 'PY'
          import papermill as pm
          pm.execute_notebook(
              'AB_Test.ipynb',        # input notebook in repo
              'AB_Test_Output.ipynb'  # output after execution
          )
          print("✅ Notebook executed and AB_Test_Output.ipynb written")
          PY

      - name: Publish metrics.json to Hugging Face Space
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          python - << 'PY'
          import os
          from huggingface_hub import HfApi, HfFolder
          HF_SPACE = "spaces/darshitkumar/ab-metrics"   # your Space
          token = os.environ["HF_TOKEN"]
          HfFolder.save_token(token)
          api = HfApi()
          # Upload/overwrite metrics.json at Space root
          api.upload_file(
              path_or_fileobj="metrics.json",
              path_in_repo="metrics.json",
              repo_id=HF_SPACE,
              repo_type="space"
          )
          print("✅ Uploaded metrics.json to Space")
          PY
